<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Меню</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: url('background.png') no-repeat center center fixed;
        background-size: cover;
      }
      .swipe-remove {
        transition: transform 0.2s ease;
      }
      .swipe-remove.swiping {
        transform: translateX(-100%);
        opacity: 0;
      }
    </style>
  </head>
  <body class="pb-36 text-sm font-sans">
    <div class="text-center text-xl font-bold p-4 border-b bg-white bg-opacity-90">Меню</div>
    <div id="tabs" class="flex justify-around mt-2 border-b text-gray-700 bg-white bg-opacity-90"></div>
    <div id="cards" class="space-y-4 p-4"></div>

    <div id="cart" class="fixed bottom-16 left-0 right-0 bg-white bg-opacity-90 border-t px-4 py-3 max-h-40 overflow-y-auto hidden">
      <div class="font-semibold mb-1">Корзина:</div>
      <div id="cart-items" class="text-sm text-gray-700"></div>
    </div>
    <button id="confirm" class="fixed bottom-0 left-0 right-0 bg-green-600 text-white py-4 text-lg hidden">Подтвердить заказ</button>

    <script>
      window.Telegram?.WebApp?.ready?.();
      let cart = [];
      const categories = {
        "казан": "Казан",
        "граммы": "Мангал",
        "меню": "Банкетное меню"
      };

      const tabs = document.getElementById("tabs");
      const cards = document.getElementById("cards");
      const cartBox = document.getElementById("cart");
      const cartItems = document.getElementById("cart-items");
      const confirm = document.getElementById("confirm");

      const sheetUrl = "https://opensheet.elk.sh/1L_ymP4fcpKC-oMuMqDLK1SVMGTnPCtWaSM0fOKW8KJw/menu";

      fetch(sheetUrl)
        .then((res) => res.json())
        .then((data) => {
          const grouped = {};
          Object.keys(categories).forEach(k => grouped[k] = []);
          data.forEach(item => {
            const type = item.Тип?.trim().toLowerCase();
            if (grouped[type]) grouped[type].push(item);
          });

          Object.entries(categories).forEach(([key, label]) => {
            if (!grouped[key]?.length) return;
            const btn = document.createElement("button");
            btn.className = "py-2 px-4";
            btn.textContent = label;
            btn.onclick = () => showCategory(key, grouped[key]);
            tabs.appendChild(btn);
          });

          showCategory("казан", grouped["казан"]);
        });

      function showCategory(type, items) {
        cards.innerHTML = "";
        items.forEach(item => {
          const card = document.createElement("div");
          card.className = "flex items-center bg-white bg-opacity-90 shadow rounded-xl p-3";

          const img = document.createElement("img");
          img.src = normalizeImage(item.Фото);
          img.className = "w-20 h-20 rounded-xl object-cover mr-4";
          card.appendChild(img);

          const content = document.createElement("div");
          content.className = "flex-1";

          content.innerHTML = `
            <div class="font-semibold mb-1">${item.Название}</div>
            <div class="text-gray-500 text-sm mb-1">${item.Описание || ""}</div>
            <div class="mb-2">Цена: ${item.Цена} ₽</div>
          `;

          const btn = document.createElement("button");
          btn.className = "bg-gray-100 w-full py-1 rounded-md text-center";
          btn.textContent = "Добавить";
          btn.onclick = () => {
            const qty = item.Тип === 'граммы' ? 300 : 1;
            cart.push({ name: item.Название, qty, price: +item.Цена });
            renderCart();
          };

          content.appendChild(btn);
          card.appendChild(content);
          cards.appendChild(card);
        });
      }

      function renderCart() {
        if (cart.length === 0) {
          cartBox.classList.add("hidden");
          confirm.classList.add("hidden");
          return;
        }
        cartBox.classList.remove("hidden");
        confirm.classList.remove("hidden");
        cartItems.innerHTML = "";
        cart.forEach((c, i) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "flex justify-between items-center mb-1 swipe-remove";
          itemDiv.innerHTML = `<span>• ${c.name} × ${c.qty} — ${c.qty * c.price} ₽</span>`;

          let startX = 0;
          itemDiv.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
          });
          itemDiv.addEventListener("touchend", (e) => {
            const endX = e.changedTouches[0].clientX;
            if (startX - endX > 50) {
              itemDiv.classList.add("swiping");
              setTimeout(() => {
                removeFromCart(i);
              }, 200);
            }
          });

          cartItems.appendChild(itemDiv);
        });
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function normalizeImage(url) {
        if (!url) return "https://via.placeholder.com/300x200?text=Нет+фото";
        if (url.includes("drive.google.com")) {
          const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
          if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
        }
        return url.trim();
      }

      confirm.onclick = () => {
        if (window.Telegram?.WebApp?.sendData) {
          const items = cart.map(c => ({ name: c.name, qty: c.qty, price: c.price }));
          Telegram.WebApp.sendData(JSON.stringify({ items }));
          Telegram.WebApp.close();
        }
      };
    </script>
  </body>
</html>
