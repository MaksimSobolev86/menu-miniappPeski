<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Меню</title>
  <script src="https://telegram.org/js/telegram-web-app.js "></script>
  <script src="https://cdn.tailwindcss.com "></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow-x: hidden;
    }
    .backdrop-blur {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .active-tab {
      font-weight: bold;
      color: black;
      white-space: nowrap;
    }
    .placeholder-icon {
      background-color: #f3f3f3;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      border-radius: 0.75rem;
      margin-right: 1rem;
    }
    .placeholder-icon svg {
      width: 40px;
      height: 40px;
      fill: #888;
    }
    #modal-content br {
      display: block;
      margin-top: 6px;
    }
  </style>
</head>
<body class="pb-[350px] text-sm font-sans">
  <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://raw.githubusercontent.com/MaksimSobolev86/menu-miniappPeski/main/bakground.png ') center top no-repeat; background-size: cover; z-index: -1;"></div>
  <div class="flex items-center justify-start px-6 py-4 border-b bg-white bg-opacity-90">
    <span class="text-xl font-bold">Меню</span>
  </div>
  <div id="tabs" class="flex gap-4 mt-2 border-b text-gray-700 bg-white bg-opacity-90 text-lg px-6 overflow-x-auto whitespace-nowrap"></div>
  <div id="cards" class="space-y-4 px-6 py-4"></div>

  <!-- Корзина -->
  <div id="cart" class="fixed bottom-0 left-0 right-0 z-50 hidden">
    <div class="bg-white rounded-t-xl shadow-[0_-8px_20px_rgba(0,0,0,0.2)] p-4 backdrop-blur">
      <div class="font-semibold text-lg mb-2 pl-6">Корзина</div>
      <div id="cart-items" class="text-sm text-gray-700 space-y-4 pl-6 pr-2 max-h-[150px] overflow-y-auto"></div>
      <div class="pt-6">
        <button id="confirm" class="bg-green-600 text-white text-lg w-full py-3 rounded-xl shadow-md">Подтвердить заказ</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full">
      <button id="modal-close" class="absolute top-2 right-3 text-gray-500 text-2xl font-bold z-10">&times;</button>
      <div class="max-h-[80vh] overflow-y-auto p-6 whitespace-pre-wrap text-sm text-gray-800" id="modal-content"></div>
    </div>
  </div>

  <script>
    // Экранирование HTML
    function htmlEscape(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Форматирование описания
    function formatDescription(text) {
      return (text || "")
        .trim()
        .replace(/(^|\n)([\p{Emoji_Presentation}\p{Extended_Pictographic}])/gu, '$1<br>$2')
        .replace(/•/g, '<br>•')
        .replace(/\n+/g, '<br>')
        .replace(/(<br>\s*){2,}/g, '<br><br>');
    }

    // Обрезка текста
    function truncate(text, maxLength = 100) {
      if (!text) return "";
      const plain = text.replace(/<[^>]+>/g, "");
      return plain.length > maxLength ? plain.slice(0, maxLength).trim() + "…" : plain;
    }

    // Нормализация ссылки на фото
    function normalizeImage(url) {
      if (!url) return "";
      if (url.includes("drive.google.com")) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
      }
      return url.trim();
    }

    // Расчёт стоимости с поддержкой фиксированной цены для 0.5
    function calculateTotal(qty, price, unit, customPriceJson) {
      if (unit === "гр") {
        return (qty / 100) * price;
      }
      if (customPriceJson) {
        try {
          const priceMap = JSON.parse(customPriceJson);
          if (qty === 0.5 && priceMap["0.5"] !== undefined) {
            return priceMap["0.5"];
          }
        } catch (e) {
          console.warn("Invalid JSON in Цена JSON:", customPriceJson);
        }
      }
      return qty * price;
    }

    // Инициализация Telegram
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    let cart = [];

    const categories = {
      "казан": "Казан",
      "граммы": "Мангал",
      "досуг": "Досуг",
      "меню": "Банкетное меню"
    };

    const tabs = document.getElementById("tabs");
    const cards = document.getElementById("cards");
    const cartBox = document.getElementById("cart");
    const cartItems = document.getElementById("cart-items");
    const confirm = document.getElementById("confirm");
    const modal = document.getElementById("modal");
    const modalContent = document.getElementById("modal-content");
    const modalClose = document.getElementById("modal-close");

    const sheetUrl = " https://opensheet.elk.sh/1L_ymP4fcpKC-oMuMqDLK1SVMGTnPCtWaSM0fOKW8KJw/menu ";

    fetch(sheetUrl)
      .then(res => res.json())
      .then(data => {
        const grouped = {};
        Object.keys(categories).forEach(k => grouped[k] = []);

        data.forEach(item => {
          const typeRaw = item.Тип || "";
          const normalizedType = typeRaw.trim().toLowerCase();
          if (Object.keys(grouped).includes(normalizedType)) {
            // Валидация JSON
            if (item["Цена JSON"]) {
              try {
                JSON.parse(item["Цена JSON"]);
              } catch (e) {
                console.warn(`Invalid JSON for ${item.Название}:`, item["Цена JSON"]);
                item["Цена JSON"] = "";
              }
            }
            grouped[normalizedType].push(item);
          }
        });

        Object.entries(categories).forEach(([key, label]) => {
          if (!grouped[key]?.length) return;
          const btn = document.createElement("button");
          btn.className = "py-2 px-4";
          btn.textContent = label;
          btn.dataset.key = key;
          btn.onclick = () => {
            setActiveTab(key);
            showCategory(key, grouped[key]);
          };
          tabs.appendChild(btn);
        });

        setActiveTab("казан");
        showCategory("казан", grouped["казан"]);
      })
      .catch(err => {
        console.error("Ошибка загрузки данных:", err);
        alert("Не удалось загрузить меню.");
      });

    function setActiveTab(key) {
      [...tabs.children].forEach(btn => {
        btn.classList.toggle("active-tab", btn.dataset.key === key);
      });
    }

    function showCategory(tabKey, items) {
      cards.innerHTML = "";
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "flex items-start bg-white bg-opacity-90 shadow rounded-xl p-3 gap-4";

        const itemType = (item.Тип || "").trim().toLowerCase();
        const isBanquetMenu = itemType === 'меню' || item.Название.toLowerCase().includes('банкет');
        const isActivity = itemType === 'досуг';

        // Парсинг фото
        const photoList = (item.Фото || "")
          .split(",")
          .map(url => url.trim())
          .filter(url => url);
        const firstImage = photoList[0] || "";

        // Фото или иконка
        let mediaBlock;
        if (itemType === "меню") {
          mediaBlock = document.createElement("div");
          mediaBlock.className = "placeholder-icon";
          mediaBlock.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M19 3h-1V2h-2v1H8V2H6v1H5c-1.1 0-2 .9-2 2v15c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 17H5V8h14v12z"/>
            </svg>`;
        } else {
          mediaBlock = document.createElement("img");
          mediaBlock.src = normalizeImage(firstImage) || "https://placehold.co/80x80/eeeeee/aaaaaa?text=%20";
          mediaBlock.className = "w-20 h-20 rounded-xl object-cover";
        }
        mediaBlock.classList.add("mr-4");
        card.appendChild(mediaBlock);

        // Контент
        const content = document.createElement("div");
        content.className = "flex-1";

        const description = item.Описание?.trim() || "";
        const shortDescription = truncate(description, 100);

        content.innerHTML = `
          <div class="font-semibold mb-1">${htmlEscape(item.Название)}</div>
          <div class="text-gray-500 text-sm mb-1">${formatDescription(htmlEscape(shortDescription))}</div>
          <div class="mb-2">Цена: ${item.Цена} ₽</div>
        `;

        if (itemType === "меню") {
          const viewBtn = document.createElement("button");
          viewBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm mt-2 shadow-md mr-2";
          viewBtn.textContent = "Посмотреть";
          viewBtn.onclick = () => {
            const githubUrl = (item.Фото || "").trim();
            const rawUrl = githubUrl
              .replace(" https://github.com/ ", "https://raw.githubusercontent.com/ ")
              .replace("/blob/", "/");
            rawUrl ? window.open(rawUrl, "_blank") : alert("Файл не найден");
          };
          content.appendChild(viewBtn);
        }

        if (itemType === "активность") {
          const viewBtn = document.createElement("button");
          viewBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm mt-2 shadow-md mr-2";
          viewBtn.textContent = "Посмотреть";
          viewBtn.onclick = () => showModal(description, item.Фото);
          content.appendChild(viewBtn);
          content.appendChild(createAddButton(item));
        }

        if (!isBanquetMenu && !isActivity) {
          content.appendChild(createAddButton(item));
        }

        card.appendChild(content);
        cards.appendChild(card);
      });
    }

    function createAddButton(item) {
      const step = parseFloat(item["Шаг"]) || 1;
      const minQty = parseFloat(item["Мин"]) || step;
      const unit = item["Ед. изм."]?.trim() || "";
      const price = parseFloat(item["Цена"]);
      const customPriceJson = item["Цена JSON"]?.trim() || "";

      const validStep = isNaN(step) || step <= 0 ? 1 : Math.round(step * 10) / 10;
      const validMinQty = isNaN(minQty) || minQty <= 0 ? validStep : Math.round(minQty * 10) / 10;

      const addBtn = document.createElement("button");
      addBtn.className = "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm mt-2 shadow-md";
      addBtn.textContent = "Добавить";
      addBtn.onclick = () => {
        const existing = cart.find(c => c.name === item.Название);
        if (existing) {
          existing.qty = Math.round((existing.qty + validStep) * 10) / 10;
        } else {
          cart.push({
            name: item.Название,
            qty: validMinQty,
            price: price,
            unit: unit,
            customPriceJson: customPriceJson
          });
        }
        renderCart();
      };
      return addBtn;
    }

    function renderCart() {
      if (!cart.length) {
        cartBox.classList.add("hidden");
        return;
      }
      cartBox.classList.remove("hidden");
      cartItems.innerHTML = "";
      cart.forEach((c, i) => {
        const total = calculateTotal(c.qty, c.price, c.unit, c.customPriceJson);
        const itemDiv = document.createElement("div");
        itemDiv.className = "flex justify-between items-center";
        itemDiv.innerHTML = `
          <span class="text-base">
            • ${htmlEscape(c.name)} × ${c.qty} ${c.unit || ""} — ${total.toFixed(0)} ₽
          </span>
          <button onclick="removeFromCart(${i})" class="text-blue-600 text-2xl font-bold ml-3">×</button>
        `;
        cartItems.appendChild(itemDiv);
      });
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }

    confirm.onclick = () => {
      if (!cart.length) {
        alert("Корзина пуста!");
        return;
      }
      if (Telegram.WebApp.sendData) {
        const payload = {
          items: cart.map(c => ({
            name: c.name,
            qty: c.qty,
            price: c.price,
            unit: c.unit,
            total: calculateTotal(c.qty, c.price, c.unit, c.customPriceJson)
          })),
          total: cart.reduce((sum, c) => sum + calculateTotal(c.qty, c.price, c.unit, c.customPriceJson), 0),
          telegram_id: Telegram.WebApp.initDataUnsafe?.user?.id || null
        };
        try {
          Telegram.WebApp.sendData(JSON.stringify(payload));
          Telegram.WebApp.close();
        } catch (e) {
          console.error("Ошибка отправки:", e);
          alert("Не удалось отправить заказ.");
        }
      }
    };

    modalClose.onclick = (e) => {
      e.preventDefault();
      modal.classList.add("hidden");
    };

    function showModal(text, imageUrlString = "") {
      const formatted = formatDescription(htmlEscape(text));

      const photoUrls = imageUrlString
        ? imageUrlString
            .split(",")
            .map(url => url.trim())
            .filter(url => url)
            .map(url => normalizeImage(url))
        : [];

      const photosHtml = photoUrls.length
        ? photoUrls.map(url => `<img src="${url}" class="w-full rounded-xl mt-2" alt="Фото" style="margin-top: 1rem;">`).join("")
        : "";

      modalContent.innerHTML = `
        <div class="mb-4">${formatted}</div>
        ${photosHtml}
      `;
      modal.classList.remove("hidden");
    }

    window.removeFromCart = removeFromCart;
  </script>
</body>
</html>
