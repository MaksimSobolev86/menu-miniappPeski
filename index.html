<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–µ–Ω—é</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow-x: hidden;
      font-family: 'Inter', sans-serif; /* Apply Inter font */
    }
    .backdrop-blur {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .active-tab {
      font-weight: bold;
      color: black;
      white-space: nowrap;
      border-bottom: 2px solid #3B82F6; /* Add blue line under active tab */
    }
  </style>
</head>
<body class="pb-[200px] text-sm">
  <!-- Static background -->
  <div style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('background.png') center top no-repeat; /* Corrected typo */
    background-size: cover;
    z-index: -1;
  "></div>

  <div class="flex items-center justify-start px-6 py-4 border-b bg-white bg-opacity-90">
    <span class="text-xl font-bold">–ú–µ–Ω—é</span>
  </div>
  <div id="tabs" class="flex gap-4 mt-2 border-b text-gray-700 bg-white bg-opacity-90 text-lg px-6 overflow-x-auto whitespace-nowrap"></div>
  <div id="cards" class="space-y-4 px-6 py-4 pb-[250px]"></div>

  <div id="cart" class="fixed bottom-0 left-0 right-0 z-50 hidden">
    <div class="bg-white rounded-t-xl shadow-[0_-8px_20px_rgba(0,0,0,0.2)] p-4 backdrop-blur">
      <div class="font-semibold text-lg mb-2 pl-6">–ö–æ—Ä–∑–∏–Ω–∞</div>
      <div id="cart-items" class="text-sm text-gray-700 space-y-4 pl-6 pr-2 max-h-[150px] overflow-y-auto"></div>
      <div class="pt-6">
        <button id="confirm" class="bg-green-600 text-white text-lg w-full py-3 rounded-xl shadow-md">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    let cart = [];
    let activeTab = null;
    const categories = {
      "–∫–∞–∑–∞–Ω": "–ö–∞–∑–∞–Ω",
      "–≥—Ä–∞–º–º—ã": "–ú–∞–Ω–≥–∞–ª",
      "–º–µ–Ω—é": "–ë–∞–Ω–∫–µ—Ç–Ω–æ–µ –º–µ–Ω—é"
    };

    const tabs = document.getElementById("tabs");
    const cards = document.getElementById("cards");
    const cartBox = document.getElementById("cart");
    const cartItems = document.getElementById("cart-items");
    const confirm = document.getElementById("confirm");

    const sheetUrl = "https://opensheet.elk.sh/1L_ymP4fcpKC-oMuMqDLK1SVMGTnPCtWaSM0fOKW8KJw/menu";

    fetch(sheetUrl)
      .then((res) => res.json())
      .then((data) => {
        const grouped = {};
        Object.keys(categories).forEach(k => grouped[k] = []);
        data.forEach(item => {
          const type = item.–¢–∏–ø?.trim().toLowerCase();
          if (grouped[type]) grouped[type].push(item);
        });

        // Create tab buttons
        Object.entries(categories).forEach(([key, label]) => {
          if (!grouped[key]?.length) return; // Skip categories without items
          const btn = document.createElement("button");
          btn.className = "py-2 px-4";
          btn.textContent = label;
          btn.dataset.key = key;
          btn.onclick = () => {
            setActiveTab(key);
            showCategory(key, grouped[key]);
          };
          tabs.appendChild(btn);
        });

        // Set default active tab and show its content
        setActiveTab("–∫–∞–∑–∞–Ω");
        showCategory("–∫–∞–∑–∞–Ω", grouped["–∫–∞–∑–∞–Ω"]);
      })
      .catch(error => console.error("Error loading data from sheet:", error));

    // Sets the active tab
    function setActiveTab(key) {
      [...tabs.children].forEach(btn => {
        if (btn.dataset.key === key) {
          btn.classList.add("active-tab");
        } else {
          btn.classList.remove("active-tab");
        }
      });
      activeTab = key; // Update active tab
    }

    // Displays items of the selected category
    function showCategory(type, items) {
      cards.innerHTML = ""; // Clear current cards
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "flex items-center bg-white bg-opacity-90 shadow rounded-xl p-3";

        const img = document.createElement("img");
        img.src = normalizeImage(item.–§–æ—Ç–æ);
        img.className = "w-20 h-20 rounded-xl object-cover mr-4";
        img.onerror = (e) => { // Handle image loading errors
          e.target.src = "https://placehold.co/80x80/cccccc/333333?text=No+photo";
        };
        card.appendChild(img);

        const content = document.createElement("div");
        content.className = "flex-1";

        content.innerHTML = `
          <div class="font-semibold mb-1">${item.–ù–∞–∑–≤–∞–Ω–∏–µ}</div>
          <div class="text-gray-500 text-sm mb-1">${item.–û–ø–∏—Å–∞–Ω–∏–µ || ""}</div>
          <div class="mb-2">–¶–µ–Ω–∞: ${item.–¶–µ–Ω–∞} ‚ÇΩ</div>
        `;

        // Create "Add" button
        const addButton = document.createElement("button");
        addButton.className = "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm mt-2 shadow-md transition duration-200 ease-in-out";
        addButton.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
        addButton.onclick = () => {
		  const type = item.–¢–∏–ø?.trim().toLowerCase();

		  // üëâ –ï—Å–ª–∏ —ç—Ç–æ –±–∞–Ω–∫–µ—Ç–Ω–æ–µ –º–µ–Ω—é ‚Äî –æ—Ç–∫—Ä—ã—Ç—å PDF –ø–æ —Å—Å—ã–ª–∫–µ
		  if (type === '–º–µ–Ω—é' || item.–ù–∞–∑–≤–∞–Ω–∏–µ.toLowerCase().includes('–±–∞–Ω–∫–µ—Ç')) {
			if (item.–§–æ—Ç–æ) {
			  window.open(item.–§–æ—Ç–æ, "_blank");
			} else {
			  alert("üìÑ –§–∞–π–ª –±–∞–Ω–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω—é –Ω–µ –Ω–∞–π–¥–µ–Ω.");
			}
			return;
		  }

		  const isGrams = type === '–≥—Ä–∞–º–º—ã';
		  const qtyToAdd = isGrams ? 1000 : 1;
		  const existing = cart.find(c => c.name === item.–ù–∞–∑–≤–∞–Ω–∏–µ);

		  let pricePerUnit;
		  if (isGrams) {
			pricePerUnit = +item.–¶–µ–Ω–∞ / 100;
		  } else {
			pricePerUnit = +item.–¶–µ–Ω–∞;
		  }

		  if (existing) {
			existing.qty += qtyToAdd;
		  } else {
			cart.push({ name: item.–ù–∞–∑–≤–∞–Ω–∏–µ, qty: qtyToAdd, price: pricePerUnit });
		  }
		  renderCart();
		};

        content.appendChild(addButton); // Add button to content block

        card.appendChild(content);
        cards.appendChild(card);
      });
    }

    // Displays cart content
    function renderCart() {
      if (cart.length === 0) {
        cartBox.classList.add("hidden"); // Hide cart if empty
        return;
      }
      cartBox.classList.remove("hidden"); // Show cart
      cartItems.innerHTML = ""; // Clear current cart items

      cart.forEach((c, i) => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "flex justify-between items-center";
        // Display quantity in kg if >= 1000g, otherwise in units
        // Total item cost: quantity * price per unit (or gram)
        itemDiv.innerHTML = `
          <span class="text-base">‚Ä¢ ${c.name} √ó ${(c.qty >= 1000) ? (c.qty / 1000 + ' –∫–≥') : c.qty} ‚Äî ${(c.qty * c.price).toFixed(0)} ‚ÇΩ</span>
          <button onclick="removeFromCart(${i})" class="text-blue-600 text-2xl font-bold ml-3">√ó</button>
        `;
        cartItems.appendChild(itemDiv);
      });
    }

    // Removes item from cart
    function removeFromCart(index) {
      cart.splice(index, 1); // Remove item by index
      renderCart(); // Update cart display
    }

    // Normalizes image URL (for Google Drive)
    function normalizeImage(url) {
      if (!url) return "https://placehold.co/80x80/cccccc/333333?text=No+photo"; // Placeholder if no URL
      if (url.includes("drive.google.com")) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
      }
      return url.trim();
    }

    // "Confirm Order" button handler
    confirm.onclick = () => {
      if (window.Telegram?.WebApp?.sendData) {
        const payload = {
          items: cart.map(c => ({ name: c.name, qty: c.qty, price: c.price })),
          total: cart.reduce((sum, c) => sum + c.qty * c.price, 0),
          telegram_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null
        };
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
      }
    };
  </script>
</body>
</html>
