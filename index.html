import { useEffect, useState } from "react";

const categories = [
  { id: "–∫–∞–∑–∞–Ω", label: "–ö–∞–∑–∞–Ω" },
  { id: "–º–∞–Ω–≥–∞–ª", label: "–ú–∞–Ω–≥–∞–ª" },
  { id: "–±–∞–Ω–∫–µ—Ç", label: "–ë–∞–Ω–∫–µ—Ç–Ω–æ–µ –º–µ–Ω—é" }
];

const MenuApp = () => {
  const [category, setCategory] = useState("–∫–∞–∑–∞–Ω");
  const [cart, setCart] = useState([]);
  const [menuItems, setMenuItems] = useState([]);

  useEffect(() => {
    if (typeof window !== "undefined" && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }

    const fetchData = async () => {
      try {
        const response = await fetch(
          "https://opensheet.elk.sh/1L_ymP4fcpKC-oMuMqDLK1SVMGTnPCtWaSM0fOKW8KJw/menu"
        );
        const data = await response.json();
        if (Array.isArray(data)) {
          setMenuItems(data);
        } else {
          console.error("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:", data);
          setMenuItems([]);
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", err);
        setMenuItems([]);
      }
    };

    fetchData();
  }, []);

  const addToCart = (item) => {
    const qty = item["–¢–∏–ø"]?.toLowerCase() === "–≥—Ä–∞–º–º—ã" ? 300 : 1;
    setCart((prev) => [...prev, { name: item["–ù–∞–∑–≤–∞–Ω–∏–µ"], qty, price: Number(item["–¶–µ–Ω–∞"]), type: item["–¢–∏–ø"] }]);
  };

  const sendOrder = () => {
    const items = cart.map((item) => ({ name: item.name, qty: item.qty, price: item.price }));
    const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
    if (typeof window !== "undefined" && window.Telegram?.WebApp?.sendData) {
      window.Telegram.WebApp.sendData(JSON.stringify({ items, total }));
      window.Telegram.WebApp.close();
    }
  };

  const filteredItems = Array.isArray(menuItems)
    ? menuItems.filter((item) => {
        const t = item["–¢–∏–ø"]?.toLowerCase();
        if (category === "–∫–∞–∑–∞–Ω") return t === "–∫–∞–∑–∞–Ω";
        if (category === "–º–∞–Ω–≥–∞–ª") return t === "–≥—Ä–∞–º–º—ã";
        return t === "–º–µ–Ω—é";
      })
    : [];

  const normalizeImage = (url) => {
    if (!url || typeof url !== "string") return "https://via.placeholder.com/300x200?text=–ù–µ—Ç+—Ñ–æ—Ç–æ";
    if (url.includes("drive.google.com")) {
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match) {
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
      }
    }
    return url.trim();
  };

  return (
    <div className="p-4 pb-36">
      <div className="flex justify-around border-b pb-2">
        {categories.map((c) => (
          <button
            key={c.id}
            onClick={() => setCategory(c.id)}
            className={`pb-1 font-medium ${
              category === c.id ? "border-b-2 border-black" : "text-gray-400"
            }`}
          >
            {c.label}
          </button>
        ))}
      </div>

      <div className="space-y-4 mt-4">
        {filteredItems.map((item, i) => (
          <div key={i} className="flex items-center bg-white shadow rounded-xl p-3">
            <img
              src={normalizeImage(item["–§–æ—Ç–æ"])}
              alt={item["–ù–∞–∑–≤–∞–Ω–∏–µ"]}
              className="w-20 h-20 rounded-xl object-cover mr-4"
            />
            <div className="flex-1">
              <div className="font-semibold text-base mb-1">{item["–ù–∞–∑–≤–∞–Ω–∏–µ"]}</div>
              <p className="text-sm text-gray-600 mb-1">{item["–û–ø–∏—Å–∞–Ω–∏–µ"]}</p>
              <div className="text-sm text-gray-800 mb-2">–¶–µ–Ω–∞: {item["–¶–µ–Ω–∞"]} ‚ÇΩ</div>
              <button
                onClick={() => addToCart(item)}
                className="bg-gray-100 w-full py-1 rounded-md text-center"
              >
                –î–æ–±–∞–≤–∏—Ç—å
              </button>
            </div>
          </div>
        ))}
      </div>

      {/* –ö–æ—Ä–∑–∏–Ω–∞ */}
      <div className="fixed bottom-16 left-0 right-0 bg-white border-t px-4 py-3 max-h-32 overflow-y-auto">
        <div className="font-medium mb-2">üß∫ –ö–æ—Ä–∑–∏–Ω–∞:</div>
        {cart.length === 0 ? (
          <div className="text-sm text-gray-500">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
        ) : (
          cart.map((item, i) => (
            <div key={i} className="text-sm">
              ‚Ä¢ {item.name} √ó {item.qty} ‚Äî {item.qty * item.price} ‚ÇΩ
            </div>
          ))
        )}
      </div>

      <button
        onClick={sendOrder}
        className="fixed bottom-0 left-0 right-0 bg-green-600 text-white text-center py-4 text-lg"
      >
        üì§ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
      </button>
    </div>
  );
};

export default MenuApp;
